# ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ User Roles ‡∏™‡∏´‡∏Å‡∏¥‡∏à‡∏®‡∏∂‡∏Å‡∏©‡∏≤ (User Roles Management System)

## ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏£‡∏∞‡∏ö‡∏ö

‡∏£‡∏∞‡∏ö‡∏ö User Roles ‡πÉ‡∏´‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏°‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ã‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏´‡∏Å‡∏¥‡∏à‡∏®‡∏∂‡∏Å‡∏©‡∏≤ ‡πÇ‡∏î‡∏¢‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏°‡∏µ‡∏´‡∏•‡∏≤‡∏¢ roles ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô (‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 3 roles)

## üéØ **User Roles ‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö**

### 1. **Admin** (‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö)
- ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏ï‡πá‡∏°‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
- ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ, ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£, ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
- ‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢ roles ‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡∏≠‡∏∑‡πà‡∏ô

### 2. **Staff** (‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏´‡∏Å‡∏¥‡∏à‡∏®‡∏∂‡∏Å‡∏©‡∏≤)
- ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÅ‡∏•‡∏∞‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó
- ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
- ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô

### 3. **Course Instructor** (‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏¥‡∏ä‡∏≤)
- ‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤
- ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
- ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô
- ‡∏™‡∏≠‡∏ô‡∏ß‡∏¥‡∏ä‡∏≤‡∏™‡∏´‡∏Å‡∏¥‡∏à‡∏®‡∏∂‡∏Å‡∏©‡∏≤

### 4. **Supervisor** (‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå‡∏ô‡∏¥‡πÄ‡∏ó‡∏®)
- ‡∏ô‡∏¥‡πÄ‡∏ó‡∏®‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤
- ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏ù‡∏∂‡∏Å‡∏á‡∏≤‡∏ô
- ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô
- ‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Å‡∏≤‡∏£

### 5. **Committee** (‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£)
- ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ù‡∏∂‡∏Å‡∏á‡∏≤‡∏ô
- ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç
- ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô

### 6. **Student** (‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤)
- ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß
- ‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£
- ‡∏™‡πà‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô

## üèóÔ∏è **‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•**

### ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏Å

#### `roles` - ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• roles
```sql
- id: ‡∏£‡∏´‡∏±‡∏™ role
- name: ‡∏ä‡∏∑‡πà‡∏≠ role (‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©)
- name_th: ‡∏ä‡∏∑‡πà‡∏≠ role (‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢)
- description: ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢
- permissions: ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á (JSON)
- is_active: ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
```

#### `user_roles` - ‡∏Å‡∏≤‡∏£‡∏Å‡∏≥‡∏´‡∏ô‡∏î roles ‡πÉ‡∏´‡πâ users
```sql
- user_id: ‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
- role_id: ‡∏£‡∏´‡∏±‡∏™ role
- is_primary: role ‡∏´‡∏•‡∏±‡∏Å (true/false)
- assigned_by: ‡∏ú‡∏π‡πâ‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢
- expires_at: ‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
- is_active: ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
```

### ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏™‡∏£‡∏¥‡∏°

#### `student_supervisors` - ‡∏Å‡∏≤‡∏£‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå‡∏ô‡∏¥‡πÄ‡∏ó‡∏®
```sql
- student_id: ‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤
- supervisor_id: ‡∏£‡∏´‡∏±‡∏™‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå‡∏ô‡∏¥‡πÄ‡∏ó‡∏®
- assignment_type: ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó (primary/secondary/backup)
```

#### `course_assignments` - ‡∏Å‡∏≤‡∏£‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏¥‡∏ä‡∏≤
```sql
- course_code: ‡∏£‡∏´‡∏±‡∏™‡∏ß‡∏¥‡∏ä‡∏≤
- course_name: ‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏ä‡∏≤
- instructor_id: ‡∏£‡∏´‡∏±‡∏™‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå
- semester: ‡∏†‡∏≤‡∏Ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
- academic_year: ‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤
```

#### `committee_assignments` - ‡∏Å‡∏≤‡∏£‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£
```sql
- committee_id: ‡∏£‡∏´‡∏±‡∏™‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£
- committee_type: ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó (evaluation/approval/review)
- scope: ‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï (department/faculty/university)
```

## üöÄ **‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏•‡∏∞‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô**

### ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1: ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏£‡∏∞‡∏ö‡∏ö roles
```sql
\i database/update-user-roles-system.sql
```

### ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 2: ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á
```sql
\i database/insert-user-roles-sample-data.sql
```

## üìã **‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô Functions**

### 1. ‡∏î‡∏π roles ‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
```sql
SELECT * FROM get_user_roles(user_id);
```

### 2. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå
```sql
SELECT check_user_permission(user_id, 'documents', 'approve');
```

### 3. ‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢ role ‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
```sql
SELECT assign_role_to_user(
    user_id, 
    'supervisor', 
    assigned_by_user_id, 
    is_primary, 
    expires_at
);
```

## üìä **‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô Views**

### 1. ‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏û‡∏£‡πâ‡∏≠‡∏° roles
```sql
SELECT * FROM user_with_roles;
```

### 2. ‡∏î‡∏π‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏´‡∏•‡∏≤‡∏¢ roles
```sql
SELECT * FROM multi_role_users;
```

### 3. ‡∏î‡∏π‡∏Å‡∏≤‡∏£‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå‡∏ô‡∏¥‡πÄ‡∏ó‡∏®
```sql
SELECT * FROM student_supervisor_assignments;
```

### 4. ‡∏î‡∏π‡∏Å‡∏≤‡∏£‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏¥‡∏ä‡∏≤
```sql
SELECT * FROM course_instructor_assignments;
```

### 5. ‡∏™‡∏£‡∏∏‡∏õ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô roles
```sql
SELECT * FROM role_summary;
```

## üîê **‡∏£‡∏∞‡∏ö‡∏ö Permissions**

### ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á JSON Permissions
```json
{
  "resource_name": ["action1", "action2", "action3"],
  "students": ["read", "write"],
  "documents": ["read", "write", "approve"],
  "evaluations": ["read", "write"],
  "reports": ["read", "write", "delete"]
}
```

### Resources ‡πÅ‡∏•‡∏∞ Actions ‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö
- **system**: read, write, delete
- **users**: read, write, delete
- **students**: read, write
- **companies**: read, write
- **documents**: read, write, approve, delete
- **evaluations**: read, write
- **visits**: read, write
- **reports**: read, write, delete

## üé≠ **‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô Multiple Roles**

### ‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏´‡∏•‡∏≤‡∏¢‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó

#### ‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå A: Course Instructor + Supervisor
```sql
-- Primary role: ‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏¥‡∏ä‡∏≤
-- Secondary role: ‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå‡∏ô‡∏¥‡πÄ‡∏ó‡∏®
SELECT assign_role_to_user(user_id, 'course_instructor', admin_id, true);
SELECT assign_role_to_user(user_id, 'supervisor', admin_id, false);
```

#### ‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå B: Supervisor + Committee
```sql
-- Primary role: ‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå‡∏ô‡∏¥‡πÄ‡∏ó‡∏®
-- Secondary role: ‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£
SELECT assign_role_to_user(user_id, 'supervisor', admin_id, true);
SELECT assign_role_to_user(user_id, 'committee', admin_id, false);
```

#### ‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå C: Course Instructor + Committee
```sql
-- Primary role: ‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏¥‡∏ä‡∏≤
-- Secondary role: ‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£
SELECT assign_role_to_user(user_id, 'course_instructor', admin_id, true);
SELECT assign_role_to_user(user_id, 'committee', admin_id, false);
```

## üìà **‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô**

### 1. ‡∏î‡∏π‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥ roles
```sql
SELECT 
    r.name_th,
    COUNT(ur.user_id) as total_users,
    COUNT(CASE WHEN ur.is_primary THEN 1 END) as primary_users
FROM roles r
LEFT JOIN user_roles ur ON r.id = ur.role_id AND ur.is_active = true
GROUP BY r.id, r.name_th;
```

### 2. ‡∏î‡∏π‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà‡∏°‡∏µ role ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏
```sql
SELECT 
    u.first_name, u.last_name, u.email,
    r.name_th as role_name,
    ur.expires_at
FROM user_roles ur
JOIN users u ON ur.user_id = u.id
JOIN roles r ON ur.role_id = r.id
WHERE ur.expires_at < CURRENT_TIMESTAMP + INTERVAL '30 days'
    AND ur.is_active = true;
```

### 3. ‡∏î‡∏π‡∏Å‡∏≤‡∏£‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö
```sql
-- ‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå‡∏ô‡∏¥‡πÄ‡∏ó‡∏®
SELECT s.student_id, u.first_name, u.last_name
FROM students s
JOIN users u ON s.user_id = u.id
LEFT JOIN student_supervisors ss ON s.id = ss.student_id AND ss.is_active = true
WHERE ss.id IS NULL;
```

## üîß **‡∏Å‡∏≤‡∏£‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏£‡∏±‡∏Å‡∏©‡∏≤**

### 1. ‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î roles ‡∏ó‡∏µ‡πà‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏
```sql
UPDATE user_roles 
SET is_active = false 
WHERE expires_at < CURRENT_TIMESTAMP AND is_active = true;
```

### 2. ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó permissions
```sql
UPDATE roles 
SET permissions = '{"new": "permissions"}'
WHERE name = 'role_name';
```

### 3. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
```sql
-- ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏°‡∏µ primary role
SELECT u.email, COUNT(ur.id) as role_count
FROM users u
LEFT JOIN user_roles ur ON u.id = ur.user_id 
    AND ur.is_primary = true AND ur.is_active = true
GROUP BY u.id, u.email
HAVING COUNT(ur.id) = 0;
```

## ‚ö†Ô∏è **‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î‡πÅ‡∏•‡∏∞‡∏Å‡∏é‡πÄ‡∏Å‡∏ì‡∏ë‡πå**

1. **‡∏à‡∏≥‡∏ô‡∏ß‡∏ô Roles ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î**: ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏Ñ‡∏ô‡∏°‡∏µ‡πÑ‡∏î‡πâ‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 3 roles
2. **Primary Role**: ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ primary role ‡πÄ‡∏û‡∏µ‡∏¢‡∏á 1 role
3. **Role Expiration**: Role ‡∏≠‡∏≤‡∏à‡∏°‡∏µ‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÑ‡∏î‡πâ
4. **Permission Inheritance**: ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏à‡∏∞‡∏£‡∏ß‡∏°‡∏Å‡∏±‡∏ô‡∏à‡∏≤‡∏Å‡∏ó‡∏∏‡∏Å roles ‡∏ó‡∏µ‡πà‡∏°‡∏µ

## üîç **‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏±‡∏ç‡∏´‡∏≤**

### ‡∏õ‡∏±‡∏ç‡∏´‡∏≤: ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ primary role
```sql
-- ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏î‡∏¢‡∏Å‡∏≥‡∏´‡∏ô‡∏î role ‡πÅ‡∏£‡∏Å‡πÄ‡∏õ‡πá‡∏ô primary
UPDATE user_roles 
SET is_primary = true 
WHERE user_id = ? AND id = (
    SELECT MIN(id) FROM user_roles WHERE user_id = ? AND is_active = true
);
```

### ‡∏õ‡∏±‡∏ç‡∏´‡∏≤: ‡∏°‡∏µ primary role ‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 1
```sql
-- ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏î‡∏¢‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞ role ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
UPDATE user_roles 
SET is_primary = false 
WHERE user_id = ? AND is_primary = true AND id != (
    SELECT MAX(id) FROM user_roles WHERE user_id = ? AND is_primary = true
);
```

## üìö **‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á**

### Scenario 1: ‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
```sql
-- 1. ‡∏™‡∏£‡πâ‡∏≤‡∏á user
INSERT INTO users (email, first_name, last_name, department, position) 
VALUES ('new.teacher@university.ac.th', '‡πÉ‡∏´‡∏°‡πà', '‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå', '‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå', '‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå');

-- 2. ‡∏Å‡∏≥‡∏´‡∏ô‡∏î role
SELECT assign_role_to_user(
    (SELECT id FROM users WHERE email = 'new.teacher@university.ac.th'),
    'course_instructor',
    (SELECT id FROM users WHERE role = 'admin' LIMIT 1),
    true
);
```

### Scenario 2: ‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå‡∏ô‡∏¥‡πÄ‡∏ó‡∏®‡πÉ‡∏´‡πâ‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤
```sql
INSERT INTO student_supervisors (student_id, supervisor_id, assignment_type, assigned_by)
VALUES (
    (SELECT id FROM students WHERE student_id = '6501001'),
    (SELECT id FROM users WHERE email = 'supervisor@university.ac.th'),
    'primary',
    (SELECT id FROM users WHERE role = 'admin' LIMIT 1)
);
```

‡∏£‡∏∞‡∏ö‡∏ö User Roles ‡πÉ‡∏´‡∏°‡πà‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏∑‡∏î‡∏´‡∏¢‡∏∏‡πà‡∏ô‡πÅ‡∏•‡∏∞‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏´‡∏Å‡∏¥‡∏à‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå!